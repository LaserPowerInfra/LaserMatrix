<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Laser Matrix ‚Äî 3D Header + Video Background</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --sidebar-w:220px;
      --accent:#1abc9c;
      --dark:#2c3e50;
      --muted:#34495e;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{display:flex;overflow:hidden;background:#f2f4f6;color:#222;}
    .sidebar{
      width:var(--sidebar-w);
      min-width:var(--sidebar-w);
      background: #add8e6;
      color:#fff;
      padding:18px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex-shrink:0;
    }
    .sidebar h2{margin:0 0 8px 0;text-align:center;color: #34495e; font-size:18px}
    .sidebar button{
      display:flex;align-items:center;gap:10px;
      background: #ff6666;
      color:#fff;border:0;padding:10px;border-radius:8px;cursor:pointer;
      font-size:15px;text-align:left;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), inset 0 -3px 0 rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }
    .sidebar button:hover{
      background: #e65c5c;
      color:#fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 -2px 0 rgba(0, 0, 0, 0.2);
      transform: translateY(1px);
    }
    .sidebar .spacer{flex-grow:1}
    .main {
      flex:1;
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      background:#fff;
    }
    .hero {
      position:relative;
      flex:1 0 auto;
      min-height:360px;
      perspective:1200px;
      overflow:hidden;
      background:#000;
    }
    .hero video{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
      -webkit-filter:brightness(0.7) saturate(1.05);filter:brightness(0.7) saturate(1.05);
    }
    .hero .overlay-top{
      position:absolute;
      top:28px;
      left:50%;
      transform:translateX(-50%);
      width:calc(100% - var(--sidebar-w) - 60px);
      max-width:1200px;
      pointer-events:none;
      text-align:center;
      z-index:5;
    }
    .three-d {
      display:inline-block;
      line-height:1;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      font-family: "Poppins", "Montserrat", Arial, sans-serif;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(220,255,240,0.9) 40%, rgba(26,188,156,0.95));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      font-size:56px;
      -webkit-text-stroke: 1px rgba(10,10,10,0.12);
      transform-origin:center top;
      transform: translateZ(40px) rotateX(6deg);
      display:block;
      margin:0 auto;
    }
    .sub-title{
      display:block;
      font-weight:700;
      letter-spacing:2px;
      color:rgba(255,255,255,0.95);
      text-shadow:0 2px 6px rgba(0,0,0,0.5);
      font-size:20px;
      margin-bottom:8px;
    }
    @media (max-width:1000px){
      .three-d{font-size:40px}
      .hero .overlay-top{top:20px}
    }
    @media (max-width:700px){
      .three-d{font-size:28px}
      .sub-title{font-size:14px}
      .hero{min-height:320px}
    }
    .panel {
      background:#f7f8fa;
      padding:18px;
      overflow:auto;
      height:calc(100vh - 40px);
    }
    .db-header { background:#fff;padding:10px;border-bottom:1px solid #e3e7ea;display:flex;align-items:center;justify-content:space-between;gap:12px; }
    .db-header input{padding:8px;border-radius:6px;border:1px solid #d6dbe0;width:220px}
    .db-item{display:flex;align-items:center;background:#fff;padding:8px;border-radius:6px;margin:8px 0;border:1px solid #e6ebee}
    .db-list{max-height:320px;overflow:auto;padding:10px}
    .table-wrap{background:#fff;padding:12px;border-radius:8px;border:1px solid #e6ebee}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e6ebee;padding:8px;text-align:left;font-size:13px; vertical-align: top;}
    thead {
        position: sticky;
        top: -1px;
        z-index: 10;
        transform: translateZ(0);
    }
    th{
        background:#f4f6f8;
    }
    .pagination{
        margin-top:12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
    }
    .btn{
      position: relative;
      overflow: hidden;
      background: #ff6666;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), inset 0 -3px 0 rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }
    .btn:hover{
      background: #e65c5c;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 -2px 0 rgba(0, 0, 0, 0.2);
      transform: translateY(1px);
    }
    .btn:disabled{
      background: #cccccc;
      color: #888888;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .btn.loading {
        pointer-events: none;
    }
    .btn.loading::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(110deg, rgba(255,255,255,0) 8%, rgba(255,255,255,0.2) 18%, rgba(255,255,255,0) 33%);
        animation: shimmer 1.5s linear infinite;
        background-size: 200% 100%;
    }
    @keyframes shimmer {
        0% { background-position: 100% 0; }
        100% { background-position: -100% 0; }
    }
    .th-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .filter-icon {
        cursor: pointer;
        font-size: 12px;
        margin-left: 8px;
        color: #555;
    }
    .filter-icon:hover { color: #000; }
    .filter-icon.active-filter {
        color: var(--accent);
        font-weight: bold;
    }
    .filter-popup, .popup-modal-overlay {
        display: none;
        position: absolute;
        z-index: 40;
    }
    .filter-popup {
        background: #fff;
        border: 1px solid #ccc;
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        border-radius: 6px;
        width: 240px;
    }
    .filter-popup-header, .filter-popup-footer {
        padding: 8px; background-color: #f7f8fa;
    }
    .filter-popup-header { font-size: 13px; border-bottom: 1px solid #eee; }
    .filter-popup-header span { cursor: pointer; color: #007bff; text-decoration: underline; margin-right: 10px; }
    .filter-popup-footer { text-align: right; border-top: 1px solid #eee; }
    .filter-popup-footer button { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; margin-left: 6px; }
    .filter-popup-search { padding: 8px; border-bottom: 1px solid #eee; }
    .filter-popup-search input { width: 100%; padding: 6px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    .filter-popup-list { max-height: 200px; overflow-y: auto; }
    .filter-popup-list label { display: block; padding: 6px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 8px; }
    .filter-popup-list label:hover { background-color: #f5f5f5; }
    .filter-popup-list label:last-child { border-bottom: none; }
    .popup-modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.4);
        display: flex; justify-content: center; align-items: center;
    }
    .popup-modal-content {
        background: white; padding: 25px 35px; border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center;
    }
  </style>
</head>
<body>

  <aside class="sidebar" role="navigation" aria-label="Main menu">
    <h2>üìÇ Menu</h2>
    <button onclick="goHome()">üè† Home</button>
    <button onclick="openDatabases()">üìä Databases</button>
    <button onclick="openForms()">üìù Forms</button>
    <div class="spacer"></div>
  </aside>

  <main class="main" id="main">
    <section class="hero" id="hero">
      </section>

    <section id="panelArea" class="panel" aria-live="polite" style="display:none;">
      </section>
  </main>

  <div id="popupMenu" class="filter-popup" style="min-width:140px; width:auto;"></div>

  <div id="filterMenu" class="filter-popup" onclick="event.stopPropagation()"></div>

  <div id="successPopup" class="popup-modal-overlay" onclick="this.style.display='none'">
    <div class="popup-modal-content" onclick="event.stopPropagation()">
      <p id="successPopupMessage" style="margin:0 0 15px 0;"></p>
      <button class="btn" onclick="document.getElementById('successPopup').style.display='none'">OK</button>
    </div>
  </div>

<script>
  let databases = JSON.parse(localStorage.getItem("databases") || "{}");
  const hero = document.getElementById('hero');
  const panelArea = document.getElementById('panelArea');
  let currentPopupDB = null;
  let currentDbName = null;
  let activeFilters = {};

  function renderHeroOverlay(){
    return `<div class="overlay-top" aria-hidden="true"><div class="sub-title">WELCOME TO</div><div class="three-d" data-text="LASER MATRIX">LASER MATRIX</div></div>`;
  }

  function goHome(){
    panelArea.style.display = 'none';
    hero.style.display = '';
    hero.innerHTML = `<video autoplay muted loop playsinline><source src="https://laserpowerinfra.com/frontassets/img/slider/Banner_v04_HD_L.mp4" type="video/mp4">Your browser does not support the video tag.</video>${renderHeroOverlay()}`;
  }

  function openForms(){
    hero.innerHTML = '';
    hero.style.display = 'none';
    panelArea.style.display = 'block';
    panelArea.innerHTML = `<div style="font-weight:700;margin-bottom:10px">Forms</div><div style="background:#fff;padding:12px;border-radius:8px">Forms functionality will go here.</div>`;
  }

  function renderDbList(searchTerm = ''){
    const all = Object.keys(databases).filter(n => n.toLowerCase().includes((searchTerm||'').toLowerCase()));
    const total = all.length;
    const listHtml = all.length ? all.map(name => `<div class="db-item"><div style="margin-right:10px;cursor:pointer" onclick="showMenu(event, '${escapeJs(name)}')">‚ãÆ</div><div style="flex:1;cursor:pointer" onclick="openDatabase('${escapeJs(name)}')">üìä ${escapeHtml(name)}</div></div>`).join('') : `<div style="padding:12px;background:#fff;border-radius:6px">No databases found.</div>`;
    document.getElementById('db-list-container').innerHTML = `<div class="db-list">${listHtml}</div>`;
    const totalElem = document.getElementById('db-total-count');
    if(totalElem) totalElem.textContent = `Total Count: ${total}`;
  }

  function openDatabases(){
    hero.innerHTML = '';
    hero.style.display = 'none';
    panelArea.style.display = 'block';
    let structureHtml = `<div class="db-header"><div style="display:flex;align-items:center;gap:12px"><div style="display:flex; align-items:center; gap: 8px;"><input id="dbSearchInput" placeholder="Search Database" value=""><button class="btn-clear" onclick="clearSearch()">Clear</button></div><div id="db-total-count" style="font-size:13px; color:#666; text-transform: uppercase; font-weight: bold;"></div></div><div><button class="btn" onclick="showImportForm()">‚ûï Add Database</button></div></div><div id="db-list-container"></div>`;
    panelArea.innerHTML = structureHtml;
    document.getElementById('dbSearchInput').addEventListener('input', (e) => { renderDbList(e.target.value); });
    renderDbList('');
  }

  function clearSearch() {
      const input = document.getElementById('dbSearchInput');
      if (input) { input.value = ''; }
      renderDbList('');
  }

  function showImportForm(){
    hero.innerHTML = '';
    hero.style.display = 'none';
    panelArea.style.display = 'block';
    panelArea.innerHTML = `<div style="font-weight:700;margin-bottom:12px">Add Database</div><div style="background:#fff;padding:12px;border-radius:8px"><div style="margin-bottom:12px"><label><strong>From CSV</strong></label><br><input type="file" id="csvFile" accept=".csv"><button class="btn" style="margin-left:8px" onclick="importCSV()">Upload</button></div><div><label><strong>From Google Sheet</strong></label><br><input type="text" id="sheetUrl" placeholder="Paste Google Sheet link here" style="width:60%"><button class="btn" onclick="importGoogleSheet()">Add</button><div id="statusBox" style="margin-top:8px"></div></div></div>`;
  }

  function importCSV(){
    const fi = document.getElementById('csvFile'), status = document.getElementById('statusBox');
    status.textContent = '';
    if(!fi || !fi.files || !fi.files.length){ status.textContent = '‚ö†Ô∏è Select a CSV file'; return; }
    const file = fi.files[0], dbName = file.name.replace(/\.csv$/i,'') || ('csvdb_' + Date.now());
    status.textContent = '‚è≥ Parsing...';
    Papa.parse(file, {
      header:true, skipEmptyLines:true, complete(res){
        databases[dbName] = { type:'csv', headers: (res.meta.fields || []).map(h => ({name:h})), rows: (res.data || []).map(r => (res.meta.fields || []).map(f => r[f] || '')) };
        localStorage.setItem('databases', JSON.stringify(databases));
        openDatabases();
      },
      error(err){ status.textContent = '‚ùå Failed: ' + (err.message || 'parse error'); }
    });
  }

  function importGoogleSheet(){
    const url = document.getElementById('sheetUrl').value.trim();
    if(!url){ alert('Paste Google Sheet url'); return; }
    const name = 'GoogleSheetDB_' + Date.now();
    databases[name] = { type:'gsheet', url:url, headers:[], rows:[] };
    localStorage.setItem('databases', JSON.stringify(databases));
    openDatabases();
  }
  
  // --- Multi-Select Filter Logic ---
  
  function getFilteredRows(filtersToApply = activeFilters) {
    const db = databases[currentDbName];
    if (!db) return [];
    
    let filteredRows = db.rows || [];
    const filterKeys = Object.keys(filtersToApply);

    if(filterKeys.length > 0) {
        filteredRows = filteredRows.filter(row => {
            return filterKeys.every(colIndex => {
                const selectedValues = filtersToApply[colIndex];
                if (!selectedValues || selectedValues.length === 0) return true;
                return selectedValues.includes(String(row[colIndex]));
            });
        });
    }
    return filteredRows;
  }

  function filterMenuOptions() {
    const searchTerm = document.getElementById('filter-search-input').value.toLowerCase();
    const options = document.querySelectorAll('#filter-options-list label');
    options.forEach(option => {
        const text = option.textContent.toLowerCase();
        option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
    });
  }
  
  function setAllFilterCheckboxes(isChecked) {
      const checkboxes = document.querySelectorAll('#filter-options-list .filter-option-cb');
      checkboxes.forEach(cb => {
        if (cb.parentElement.style.display !== 'none') {
            cb.checked = isChecked;
        }
      });
  }

  function showFilterMenu(event, columnIndex) {
    event.stopPropagation();
    hideFilterMenu();
    const db = databases[currentDbName];
    if (!db) return;
    
    const tempFilters = { ...activeFilters };
    delete tempFilters[columnIndex];
    const relevantRows = getFilteredRows(tempFilters);

    const uniqueValues = new Set();
    relevantRows.forEach(row => {
        if(row[columnIndex] !== '' && row[columnIndex] !== null) uniqueValues.add(row[columnIndex]);
    });
    
    const currentSelection = new Set(activeFilters[columnIndex] || []);
    let sortedValues = [...uniqueValues];

    if (currentSelection.size > 0) {
        sortedValues.sort((a, b) => {
            const aIsSelected = currentSelection.has(a);
            const bIsSelected = currentSelection.has(b);
            if (aIsSelected && !bIsSelected) return -1;
            if (!aIsSelected && bIsSelected) return 1;
            return String(a).localeCompare(String(b));
        });
    } else {
        sortedValues.sort((a,b) => String(a).localeCompare(String(b)));
    }
    
    let listItemsHtml = '';
    sortedValues.forEach(value => {
        const isChecked = currentSelection.size === 0 || currentSelection.has(value);
        listItemsHtml += `<label><input type="checkbox" class="filter-option-cb" value="${escapeHtml(value)}" ${isChecked ? 'checked' : ''}> ${escapeHtml(value)}</label>`;
    });

    const menu = document.getElementById('filterMenu');
    menu.innerHTML = `<div class="filter-popup-header"><span onclick="setAllFilterCheckboxes(true)">(Select All)</span><span onclick="setAllFilterCheckboxes(false)">(Clear All)</span></div><div class="filter-popup-search"><input type="text" id="filter-search-input" onkeyup="filterMenuOptions()" placeholder="Search options..."></div><div class="filter-popup-list" id="filter-options-list">${listItemsHtml}</div><div class="filter-popup-footer"><button onclick="hideFilterMenu()">Cancel</button><button onclick="applyMultiSelectFilter(${columnIndex})" style="background-color:var(--accent); color:white;">Apply</button></div>`;
    
    menu.style.display = 'block';
    menu.style.left = (event.pageX - 5) + 'px';
    menu.style.top = (event.pageY + 10) + 'px';
    document.getElementById('filter-search-input').focus();
  }

  function applyMultiSelectFilter(columnIndex) {
    const selectedValues = [];
    document.querySelectorAll('#filter-options-list .filter-option-cb:checked').forEach(cb => {
        selectedValues.push(cb.value);
    });

    const allValuesInMenu = [];
    document.querySelectorAll('#filter-options-list .filter-option-cb').forEach(cb => {
        allValuesInMenu.push(cb.value);
    });

    if (selectedValues.length === allValuesInMenu.length || selectedValues.length === 0) {
        delete activeFilters[columnIndex];
    } else {
        activeFilters[columnIndex] = selectedValues;
    }
    renderFilteredAndPagedTable(1);
    hideFilterMenu();
  }
  
  function hideFilterMenu() {
    document.getElementById('filterMenu').style.display = 'none';
  }
  
  function clearAllFilters() {
    activeFilters = {};
    renderFilteredAndPagedTable(1);
  }
  
  function updateFilterIcons() {
      const db = databases[currentDbName];
      if (!db || !db.headers) return;
      db.headers.forEach((header, index) => {
          const icon = document.getElementById(`filter-icon-${index}`);
          if (icon) {
              if (activeFilters[index] && activeFilters[index].length > 0) {
                  icon.classList.add('active-filter');
              } else {
                  icon.classList.remove('active-filter');
              }
          }
      });
  }
  
  function renderFilteredAndPagedTable(page = 1) {
    const filteredRows = getFilteredRows();
    const rowsPerPage = 100;
    
    const totalPages = Math.max(1, Math.ceil(filteredRows.length / rowsPerPage));
    page = Math.min(Math.max(1, page), totalPages);
    
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const paginatedRows = filteredRows.slice(start, end);

    const body = document.getElementById('data-table-body');
    if(body) body.innerHTML = paginatedRows.map(r => `<tr>${r.map(c => `<td>${escapeHtml(String(c||''))}</td>`).join('')}</tr>`).join('');
    
    const paginationContainer = document.getElementById('pagination-container');
    if (paginationContainer) {
        const paginationHtml = `<div style="flex: 1; text-align: left;">Go to page: <input type="number" min="1" max="${totalPages}" value="${page}" onchange="jumpToPage(this.value)" style="width: 60px;"></div><div style="flex: 1; text-align: center;"><button class="btn" onclick="renderFilteredAndPagedTable(${page - 1})" ${page === 1 ? 'disabled' : ''}>‚¨Ö Prev</button><span style="margin:0 8px">Page ${page} of ${totalPages}</span><button class="btn" onclick="renderFilteredAndPagedTable(${page + 1})" ${page === totalPages ? 'disabled' : ''}>Next ‚û°</button></div><div style="flex: 1; text-align: right; font-weight: bold;" id="data-count-display">Data Count: ${filteredRows.length}</div>`;
        paginationContainer.innerHTML = `<div class="pagination">${paginationHtml}</div>`;
    }

    updateFilterIcons();
  }

  function jumpToPage(value) {
    const pageNum = parseInt(value);
    if (pageNum && pageNum > 0) {
        renderFilteredAndPagedTable(pageNum);
    }
  }

  async function fetchAndSaveGSheet(dbName) {
    const db = databases[dbName];
    if (!db || !db.url) return;

    db.rows = [];
    db.headers = [];
    
    let csvUrl = db.url;
    if(db.url.includes('/edit')) csvUrl = db.url.replace('/edit','/gviz/tq?tqx=out:csv');
    else if(db.url.includes('/pub')) csvUrl = db.url.replace('/pub','/pub?output=csv');
    
    const cacheBuster = '&_=' + new Date().getTime();
    const finalUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(csvUrl) + cacheBuster;

    const r = await fetch(finalUrl);
    if (!r.ok) throw new Error('Network response was not ok');
    const txt = await r.text();
    const parsed = Papa.parse(txt, { header:true, skipEmptyLines:true });
    db.headers = (parsed.meta.fields || []).map(f=>({name:f}));
    db.rows = (parsed.data || []).map(row => db.headers.map(h => row[h.name] || ''));
    databases[dbName] = db;
    localStorage.setItem('databases', JSON.stringify(databases));
  }

  async function openDatabase(dbName, forceRefresh = false){
    currentDbName = dbName;
    if (!forceRefresh) activeFilters = {};
    
    let db = databases[dbName];
    if(!db){ alert('DB not found'); return; }

    if (db.type === 'gsheet' && (!db.rows || db.rows.length === 0 || forceRefresh)) {
        if(forceRefresh) document.getElementById('manual-refresh-btn')?.classList.add('loading');
        try {
            await fetchAndSaveGSheet(dbName);
            if (forceRefresh) showSuccessPopup('Data has been refreshed successfully!');
        } catch(e) {
            console.warn('gsheet fetch failed', e);
            alert('Failed to fetch data from Google Sheet. Check the link or network.');
        } finally {
            if(forceRefresh) document.getElementById('manual-refresh-btn')?.classList.remove('loading');
        }
    }

    db = databases[dbName];
    
    if (!document.getElementById('data-table') || forceRefresh === false) {
        const headerHtml = (db.headers||[]).map((h, i) => `<th><div class="th-content"><span>${escapeHtml(h.name)}</span><span id="filter-icon-${i}" class="filter-icon" onclick="showFilterMenu(event, ${i})">&#9660;</span></div></th>`).join('');
        const tableHtml = `
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <div style="font-weight:700;">${escapeHtml(dbName)}</div>
            <div style="display:flex; gap: 10px;">
                 <button class="btn" id="manual-refresh-btn" onclick="manualRefresh()">Manual Refresh</button>
                 <button class="btn" onclick="scheduleRefresh()">Schedule Refresh</button>
                 <button class="btn" onclick="clearAllFilters()">Clear All Filters</button>
                 <button class="btn" onclick="openDatabases()">‚¨ÖÔ∏è Back to List</button>
            </div>
          </div>
          <div class="table-wrap">
            <div style="overflow:auto; max-height:75vh;">
              <table id="data-table">
                <thead><tr>${headerHtml}</tr></thead>
                <tbody id="data-table-body"></tbody>
              </table>
            </div>
            <div id="pagination-container"></div>
          </div>
        `;
        panelArea.innerHTML = tableHtml;
    }
    
    renderFilteredAndPagedTable(1);
  }

  async function manualRefresh() {
      if (currentDbName) {
          const btn = document.getElementById('manual-refresh-btn');
          if(btn) btn.classList.add('loading');
          await openDatabase(currentDbName, true);
          if(btn) btn.classList.remove('loading');
      }
  }

  function scheduleRefresh() {
      alert("This feature requires a backend server to run scheduled tasks even when the browser is closed. This is a planned future enhancement.");
  }

  function showSuccessPopup(message) {
      document.getElementById('successPopupMessage').textContent = message;
      document.getElementById('successPopup').style.display = 'flex';
  }

  function showMenu(ev, dbName){
    ev.stopPropagation();
    currentPopupDB = dbName;
    const menu = document.getElementById('popupMenu');
    menu.innerHTML = `<div style="padding:8px;cursor:pointer" onclick="renameDatabase()">üìù Rename</div><div style="padding:8px;cursor:pointer" onclick="deleteDatabase()">üóë Delete</div>`;
    menu.style.display='block';
    menu.style.left = (ev.clientX - 10) + 'px';
    menu.style.top  = (ev.clientY + 6) + 'px';
  }
  document.addEventListener('click', ()=> {
    document.getElementById('popupMenu').style.display='none'
    hideFilterMenu();
  });

  function renameDatabase(){
    const newName = prompt('Enter new name for database', currentPopupDB);
    if(!newName) return;
    if(databases[newName]){ alert('Name already exists'); return; }
    databases[newName] = databases[currentPopupDB];
    delete databases[currentPopupDB];
    localStorage.setItem('databases', JSON.stringify(databases));
    openDatabases();
  }
  function deleteDatabase(){
    if(!confirm('Delete database "'+currentPopupDB+'" ?')) return;
    delete databases[currentPopupDB];
    localStorage.setItem('databases', JSON.stringify(databases));
    openDatabases();
  }

  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function escapeJs(s){ return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

  goHome();
</script>
</body>
</html>