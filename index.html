<script>
  let databases = JSON.parse(localStorage.getItem("databases") || "{}");
  let currentPopupDB = null;
  let historyStack = [];

  function saveDatabases() {
    localStorage.setItem("databases", JSON.stringify(databases));
  }

  function setContent(html, saveHistory = true) {
    const content = document.getElementById("content");
    if (saveHistory) historyStack.push(content.innerHTML);
    content.innerHTML = html;
  }

  function openDatabases() {
    setContent(`
      <h2>Databases</h2>
      <button onclick="showImportForm()">‚ûï Add Database</button>
      <div id="dbList">
        ${Object.keys(databases).length ?
          Object.keys(databases).map(db => `
            <div class="db-item">
              <div class="db-menu" onclick="showMenu(event, '${db}')">‚ãÆ</div>
              <div class="db-left" onclick="openDatabase('${db}')">üìä ${db}</div>
            </div>
          `).join("")
          : "<p>No databases yet.</p>"}
      </div>
    `);
  }

  function showImportForm() {
    setContent(`
      <h2>Add Database</h2>
      <h3>üìÇ From CSV</h3>
      <input type="file" id="csvFile" accept=".csv">
      <button onclick="importCSV()">Upload</button>
      <div id="statusBox"></div>
      <div id="errorBox"></div>

      <h3>üåç From Google Sheet</h3>
      <input type="text" id="sheetUrl" placeholder="Paste Google Sheet link here" size="60">
      <button onclick="importGoogleSheet()">Add</button>
      <div id="sheetStatus"></div>
    `);
  }

  // ‚úÖ CSV Import (streaming)
  function importCSV() {
    const fileInput = document.getElementById("csvFile");
    const statusBox = document.getElementById("statusBox");
    const err = document.getElementById("errorBox");
    err.style.display = "none"; err.textContent = "";
    if (!fileInput.files.length) {
      err.textContent = "‚ö†Ô∏è Please select a CSV file.";
      err.style.display = "block";
      return;
    }

    const file = fileInput.files[0];
    statusBox.innerHTML = "<p class='loading'>‚è≥ Loading...</p>";

    let headers = [];
    let rows = [];
    let dbName = file.name.replace(".csv", "");
    let rowCount = 0;

    Papa.parse(file, {
      header: true,
      worker: true,
      skipEmptyLines: true,
      step: function (row) {
        if (rowCount === 0) {
          headers = Object.keys(row.data);
          databases[dbName] = {
            headers: headers.map(h => ({ name: h, type: "Text" })),
            rows: []
          };
        }
        // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ 1000 row sample ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨
        if (rowCount < 1000) {
          databases[dbName].rows.push(headers.map(h => row.data[h] || ""));
        }
        rowCount++;
      },
      complete: function () {
        saveDatabases();
        statusBox.innerHTML = `<p class='success'>‚úÖ Upload Done! (${rowCount} rows, showing sample)</p>`;
        openDatabases();
      },
      error: function () {
        err.textContent = "‚ùå Failed to read file!";
        err.style.display = "block";
        statusBox.innerHTML = "";
      }
    });
  }

  // ‚úÖ Google Sheet Import (streaming)
  async function importGoogleSheet() {
    const url = document.getElementById("sheetUrl").value;
    const status = document.getElementById("sheetStatus");
    status.textContent = "‚åõ Loading from Google Sheet...";

    try {
      let csvUrl = url.includes("output=csv") ? url : url.replace("/edit", "/gviz/tq?tqx=out:csv");
      const response = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(csvUrl));
      const csvText = await response.text();

      let headers = [];
      let rows = [];
      let dbName = "GoogleSheetDB_" + Date.now();
      let rowCount = 0;

      Papa.parse(csvText, {
        header: true,
        worker: true,
        skipEmptyLines: true,
        step: function (row) {
          if (rowCount === 0) {
            headers = Object.keys(row.data);
            databases[dbName] = {
              headers: headers.map(h => ({ name: h, type: "Text" })),
              rows: []
            };
          }
          if (rowCount < 1000) {
            databases[dbName].rows.push(headers.map(h => row.data[h] || ""));
          }
          rowCount++;
        },
        complete: function () {
          saveDatabases();
          status.innerHTML = `<p class='success'>‚úÖ Upload Done! (${rowCount} rows, showing sample)</p>`;
          openDatabases();
        }
      });
    } catch (err) {
      status.innerHTML = "<p style='color:red'>‚ùå Failed to fetch from Google Sheet!</p>";
      console.error(err);
    }
  }

  // ‚úÖ Open DB with pagination (sample only)
  function openDatabase(dbName, page = 1) {
    const db = databases[dbName];
    const rowsPerPage = 100;
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const totalPages = Math.ceil(db.rows.length / rowsPerPage);

    let tableHTML = `
      <div style="overflow-x:auto; max-height:70vh; border:1px solid #ccc; border-radius:4px;">
        <table>
          <thead>
            <tr>${db.headers.map(h => `<th>${h.name}</th>`).join("")}</tr>
          </thead>
          <tbody>
            ${db.rows.slice(start, end).map(row => `
              <tr>${row.map(cell => `<td>${cell || ""}</td>`).join("")}</tr>
            `).join("")}
          </tbody>
        </table>
      </div>
      <div style="margin-top:10px; text-align:center;">
        <button onclick="openDatabase('${dbName}', ${page - 1})" ${page === 1 ? "disabled" : ""}>‚¨Ö Prev</button>
        <span> Page ${page} of ${totalPages} </span>
        <button onclick="openDatabase('${dbName}', ${page + 1})" ${page === totalPages ? "disabled" : ""}>Next ‚û°</button>
      </div>
    `;
    setContent(`<h2>${dbName}</h2>${tableHTML}`, false);
  }

  function goHome() { setContent("<h2>Welcome</h2><p>Select an option from the menu.</p>"); }
  function goBack() { if (historyStack.length > 0) document.getElementById("content").innerHTML = historyStack.pop(); }
  function openForms() { setContent("<h2>Forms</h2><p>Forms functionality will go here.</p>"); }

  function showMenu(e, dbName) {
    e.stopPropagation();
    currentPopupDB = dbName;
    const menu = document.getElementById("popupMenu");
    menu.style.display = "block";
    const rect = e.target.getBoundingClientRect();
    menu.style.left = rect.left + "px";
    menu.style.top = rect.bottom + "px";
  }
  document.addEventListener("click", () => { document.getElementById("popupMenu").style.display = "none"; });
  function renameDatabase() {
    const newName = prompt("Enter new name:", currentPopupDB);
    if (newName && !databases[newName]) {
      databases[newName] = databases[currentPopupDB];
      delete databases[currentPopupDB];
      saveDatabases();
      openDatabases();
    }
    document.getElementById("popupMenu").style.display = "none";
  }
  function deleteDatabase() {
    if (confirm("Delete database '" + currentPopupDB + "'?")) {
      delete databases[currentPopupDB];
      saveDatabases();
      openDatabases();
    }
    document.getElementById("popupMenu").style.display = "none";
  }
</script>
