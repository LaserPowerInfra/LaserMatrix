<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Database & Form Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; display:flex; height:100vh; }
    .sidebar { width:220px; background:#2c3e50; color:white; padding:15px; box-sizing:border-box; }
    .sidebar h2 { font-size:18px; margin:0 0 10px; }
    .sidebar button { width:100%; padding:8px; margin:5px 0; border:none; background:#34495e; color:white; cursor:pointer; border-radius:4px; }
    .sidebar button:hover { background:#1abc9c; }
    .content { flex-grow:1; padding:20px; overflow:auto; }
    table { border-collapse:collapse; width:100%; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:6px; font-size:14px; }
    th { background:#f4f4f4; position:sticky; top:0; }
    .db-item { display:flex; align-items:center; border:1px solid #ccc; margin:5px 0; padding:5px; border-radius:4px; background:#f9f9f9; }
    .db-menu { cursor:pointer; padding:0 8px; }
    .db-left { flex-grow:1; cursor:pointer; padding-left:8px; text-align:left; }
    .menu-item { padding:8px 12px; cursor:pointer; }
    .menu-item:hover { background:#f0f0f0; }
    .menu-item:active { background:#d0d0d0; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Menu</h2>
    <button onclick="openHome()">üè† Home</button>
    <button onclick="openDatabases()">üìÇ Databases</button>
    <button onclick="openForms()">üìù Forms</button>
  </div>
  <div class="content" id="mainContent">
    <h2>Welcome</h2>
    <p>Select an option from the left.</p>
  </div>

  <!-- Popup Menu -->
  <div id="popupMenu" 
       style="position:absolute; display:none; background:white; border:1px solid #ccc; 
              padding:5px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); min-width:120px;">
    <div class="menu-item" onclick="renameDatabase()">üìù Rename</div>
    <div class="menu-item" onclick="deleteDatabase()">üóë Delete</div>
  </div>

<script>
let databases = JSON.parse(localStorage.getItem("databases") || "{}");
let forms = JSON.parse(localStorage.getItem("forms") || "{}");
let selectedDb = null;

function saveDatabases(){ localStorage.setItem("databases", JSON.stringify(databases)); }
function saveForms(){ localStorage.setItem("forms", JSON.stringify(forms)); }

function setContent(html, save=true){ document.getElementById("mainContent").innerHTML = html; if(save) saveDatabases(); }

function openHome(){ setContent("<h2>Home</h2><p>Welcome to your app!</p>"); }

function openDatabases(){
  setContent(`
    <h2>Databases</h2>
    <button onclick="showImportForm()">‚ûï Add Database</button>
    <div id="dbList">
      ${Object.keys(databases).length ?
        Object.keys(databases).map(db => `
          <div class="db-item">
            <div class="db-menu" onclick="showMenu(event, '${db}')">‚ãÆ</div>
            <div class="db-left" onclick="openDatabase('${db}')">üìä ${db}</div>
          </div>
        `).join("")
        : "<p>No databases yet.</p>"}
    </div>
  `);
}

function showMenu(e, dbName){
  e.stopPropagation();
  selectedDb = dbName;
  const menu = document.getElementById("popupMenu");
  menu.style.display = "block";
  menu.style.left = e.pageX + "px";
  menu.style.top = e.pageY + "px";
}

window.onclick = () => document.getElementById("popupMenu").style.display = "none";

function renameDatabase(){
  let newName = prompt("Enter new name:", selectedDb);
  if(newName && !databases[newName]){
    databases[newName] = databases[selectedDb];
    delete databases[selectedDb];
    saveDatabases(); openDatabases();
  }
}

function deleteDatabase(){
  if(confirm("Delete database: " + selectedDb + "?")){
    delete databases[selectedDb];
    saveDatabases(); openDatabases();
  }
}

async function openDatabase(dbName, page=1){
  const db = databases[dbName];

  // ‡¶Ø‡¶¶‡¶ø ‡¶è‡¶ü‡¶æ Google Sheet ‡¶π‡¶Ø‡¶º ‚Üí fresh fetch ‡¶ï‡¶∞‡ßã
  if(db.type === "gsheet"){
    let csvUrl = db.url;
    if(csvUrl.includes("/edit")){
      csvUrl = csvUrl.replace("/edit", "/gviz/tq?tqx=out:csv");
    } else if(csvUrl.includes("/pub")){
      csvUrl = csvUrl.replace("/pub", "/pub?output=csv");
    }
    const response = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(csvUrl));
    const csvText = await response.text();
    let parsed = Papa.parse(csvText, {header:true, skipEmptyLines:true});
    db.headers = parsed.meta.fields.map(h => ({name:h, type:"Text"}));
    db.rows = parsed.data.map(row => db.headers.map(h => row[h.name] || ""));
  }

  const rowsPerPage = 100;
  const start = (page-1) * rowsPerPage;
  const end = start + rowsPerPage;
  const totalPages = Math.ceil(db.rows.length / rowsPerPage);

  let tableHTML = `
    <div style="overflow-x:auto; max-height:70vh; border:1px solid #ccc; border-radius:4px;">
      <table>
        <thead><tr>${db.headers.map(h=>`<th>${h.name}</th>`).join("")}</tr></thead>
        <tbody>
          ${db.rows.slice(start,end).map(row=>`
            <tr>${row.map(cell=>`<td>${cell||""}</td>`).join("")}</tr>
          `).join("")}
        </tbody>
      </table>
    </div>
    <div style="margin-top:10px; text-align:center;">
      <button onclick="openDatabase('${dbName}', ${page-1})" ${page===1?"disabled":""}>‚¨Ö Prev</button>
      <span> Page ${page} of ${totalPages} </span>
      <button onclick="openDatabase('${dbName}', ${page+1})" ${page===totalPages?"disabled":""}>Next ‚û°</button>
    </div>
  `;
  setContent(`<h2>${dbName}</h2>${tableHTML}`, false);
}

function showImportForm(){
  setContent(`
    <h2>Add Database</h2>
    <h3>üìÇ From CSV</h3>
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="importCSV()">Upload</button>
    <h3>üåç From Google Sheet</h3>
    <input type="text" id="sheetUrl" placeholder="Paste Google Sheet link here">
    <button onclick="importGoogleSheet()">Add</button>
    <div id="sheetStatus"></div>
  `);
}

function importCSV(){
  const file = document.getElementById("csvFile").files[0];
  if(!file) return alert("Choose a CSV file!");
  Papa.parse(file, {
    header:true, skipEmptyLines:true,
    complete:function(results){
      const headers = results.meta.fields.map(h=>({name:h, type:"Text"}));
      const rows = results.data.map(row=>headers.map(h=>row[h.name]||""));
      let dbName = file.name.replace(".csv","");
      databases[dbName] = {type:"csv", headers, rows};
      saveDatabases(); openDatabases();
    }
  });
}

function importGoogleSheet(){
  const url = document.getElementById("sheetUrl").value.trim();
  if(!url) return alert("Enter a Google Sheet link!");
  let dbName = "GoogleSheet_" + Date.now();
  databases[dbName] = {type:"gsheet", url, headers:[], rows:[]};
  saveDatabases();
  document.getElementById("sheetStatus").innerHTML = "<p style='color:green'>‚úÖ Google Sheet added (Live)</p>";
  openDatabases();
}

function openForms(){
  setContent("<h2>Forms</h2><p>Coming soon...</p>");
}
</script>
</body>
</html>
