<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Laser Matrix</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; display:flex; height:100vh; }

    /* Sidebar */
    .sidebar {
      width: 220px;
      min-width: 220px;
      max-width: 220px;
      background: #2c3e50;
      color: white;
      padding: 15px;
      box-sizing: border-box;
      flex-shrink: 0;
    }
    .sidebar button {
      width:100%;
      padding:10px;
      margin:6px 0;
      border:none;
      background:#34495e;
      color:white;
      cursor:pointer;
      border-radius:6px;
      text-align:left;
    }
    .sidebar button:hover { background:#1abc9c; }

    /* Content */
    .content { flex-grow:1; padding:20px; overflow:auto; }

    /* Table */
    table { border-collapse:collapse; width:100%; font-size:14px; }
    th, td { border:1px solid #ccc; padding:6px; }
    th { background:#f4f4f4; position:sticky; top:0; z-index:1; }

    /* Database item */
    .db-item {
      display:flex; align-items:center;
      border:1px solid #ccc; margin:5px 0; padding:5px;
      border-radius:4px; background:#f9f9f9;
    }
    .db-menu { cursor:pointer; padding:0 8px; }
    .db-left { flex-grow:1; cursor:pointer; padding-left:8px; text-align:left; }

    /* Popup menu */
    #popupMenu {
      position:absolute;
      display:none;
      background:white;
      border:1px solid #ccc;
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      min-width:120px;
    }
    .menu-item { padding:8px 12px; cursor:pointer; }
    .menu-item:hover { background:#f0f0f0; }
    .menu-item:active { background:#d0d0d0; }
  </style>
</head>
<body onload="goHome()">

  <!-- Sidebar -->
  <div class="sidebar">
    <button onclick="goHome()">üè† Home</button>
    <button onclick="openDatabases()">üìä Databases</button>
    <button onclick="openForms()">üìù Forms</button>
  </div>

  <!-- Main content -->
  <div id="content" class="content"></div>

  <!-- Popup menu -->
  <div id="popupMenu">
    <div class="menu-item" onclick="renameDatabase()">üìù Rename</div>
    <div class="menu-item" onclick="deleteDatabase()">üóë Delete</div>
  </div>

  <script>
    let databases = JSON.parse(localStorage.getItem("databases") || "{}");
    let currentPopupDB = null;
    let historyStack = [];

    function saveDatabases() {
      localStorage.setItem("databases", JSON.stringify(databases));
    }

    function setContent(html, saveHistory = true) {
      const content = document.getElementById("content");
      if (saveHistory) historyStack.push(content.innerHTML);
      content.innerHTML = html;
    }

    function openDatabases() {
      setContent(`
        <h2>Databases</h2>
        <button onclick="showImportForm()">‚ûï Add Database</button>
        <div id="dbList">
          ${Object.keys(databases).length ?
            Object.keys(databases).map(db => `
              <div class="db-item">
                <div class="db-menu" onclick="showMenu(event, '${db}')">‚ãÆ</div>
                <div class="db-left" onclick="openDatabase('${db}')">üìä ${db}</div>
              </div>
            `).join("")
            : "<p>No databases yet.</p>"}
        </div>
      `);
    }

    function showImportForm() {
      setContent(`
        <h2>Add Database</h2>
        <h3>üìÇ From CSV</h3>
        <input type="file" id="csvFile" accept=".csv">
        <button onclick="importCSV()">Upload</button>
        <div id="statusBox"></div>
        <div id="errorBox"></div>

        <h3>üåç From Google Sheet</h3>
        <input type="text" id="sheetUrl" placeholder="Paste Google Sheet link here" size="60">
        <button onclick="importGoogleSheet()">Add</button>
        <div id="sheetStatus"></div>
      `);
    }

    // CSV Import
    function importCSV() {
      const fileInput = document.getElementById("csvFile");
      const statusBox = document.getElementById("statusBox");
      const err = document.getElementById("errorBox");
      err.style.display = "none"; err.textContent = "";
      if (!fileInput.files.length) {
        err.textContent = "‚ö†Ô∏è Please select a CSV file.";
        err.style.display = "block";
        return;
      }

      const file = fileInput.files[0];
      statusBox.innerHTML = "<p class='loading'>‚è≥ Loading...</p>";

      let headers = [];
      let rowCount = 0;
      let dbName = file.name.replace(".csv", "");

      Papa.parse(file, {
        header: true,
        worker: true,
        skipEmptyLines: true,
        step: function (row) {
          if (rowCount === 0) {
            headers = Object.keys(row.data);
            databases[dbName] = {
              type: "csv",
              headers: headers.map(h => ({ name: h, type: "Text" })),
              rows: []
            };
          }
          if (rowCount < 1000) {
            databases[dbName].rows.push(headers.map(h => row.data[h] || ""));
          }
          rowCount++;
        },
        complete: function () {
          saveDatabases();
          statusBox.innerHTML = `<p class='success'>‚úÖ Upload Done! (${rowCount} rows, showing sample)</p>`;
          openDatabases();
        },
        error: function () {
          err.textContent = "‚ùå Failed to read file!";
          err.style.display = "block";
          statusBox.innerHTML = "";
        }
      });
    }

    // Google Sheet Import
    function importGoogleSheet() {
      const url = document.getElementById("sheetUrl").value.trim();
      if (!url) return;
      let dbName = "GoogleSheetDB_" + Date.now();
      databases[dbName] = { type: "gsheet", url: url, headers: [], rows: [] };
      saveDatabases();
      openDatabases();
    }

    // Open Database
    async function openDatabase(dbName, page = 1) {
      const db = databases[dbName];

      if (db.type === "gsheet") {
        let csvUrl;
        if (db.url.includes("output=csv")) {
          csvUrl = db.url;
        } else if (db.url.includes("/edit")) {
          csvUrl = db.url.replace("/edit", "/gviz/tq?tqx=out:csv");
        } else if (db.url.includes("/pub")) {
          csvUrl = db.url.replace("/pub", "/pub?output=csv");
        } else {
          alert("Invalid Google Sheet URL"); return;
        }

        const response = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(csvUrl));
        const csvText = await response.text();
        let parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });

        db.headers = parsed.meta.fields.map(h => ({ name: h, type: "Text" }));
        db.rows = parsed.data.map(row => db.headers.map(h => row[h.name] || ""));
      }

      const rowsPerPage = 100;
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const totalPages = Math.ceil(db.rows.length / rowsPerPage);

      let tableHTML = `
        <div style="overflow-x:auto; overflow-y:auto; max-height:70vh; border:1px solid #ccc; border-radius:4px; display:block;">
          <table>
            <thead>
              <tr>${db.headers.map(h => `<th>${h.name}</th>`).join("")}</tr>
            </thead>
            <tbody>
              ${db.rows.slice(start, end).map(row => `
                <tr>${row.map(cell => `<td>${cell || ""}</td>`).join("")}</tr>
              `).join("")}
            </tbody>
          </table>
        </div>
        <div style="margin-top:10px; text-align:center;">
          <button onclick="openDatabase('${dbName}', ${page - 1})" ${page === 1 ? "disabled" : ""}>‚¨Ö Prev</button>
          <span> Page ${page} of ${totalPages} </span>
          <button onclick="openDatabase('${dbName}', ${page + 1})" ${page === totalPages ? "disabled" : ""}>Next ‚û°</button>
        </div>
      `;
      setContent(`<h2>${dbName}</h2>${tableHTML}`, false);
    }

    function goHome() { setContent("<h2>Welcome</h2><p>Select an option from the menu.</p>"); }
    function openForms() { setContent("<h2>Forms</h2><p>Forms functionality will go here.</p>"); }

    function showMenu(e, dbName) {
      e.stopPropagation();
      currentPopupDB = dbName;
      const menu = document.getElementById("popupMenu");
      menu.style.display = "block";
      const rect = e.target.getBoundingClientRect();
      menu.style.left = rect.left + "px";
      menu.style.top = rect.bottom + "px";
    }
    document.addEventListener("click", () => { document.getElementById("popupMenu").style.display = "none"; });

    function renameDatabase() {
      const newName = prompt("Enter new name:", currentPopupDB);
      if (newName && !databases[newName]) {
        databases[newName] = databases[currentPopupDB];
        delete databases[currentPopupDB];
        saveDatabases();
        openDatabases();
      }
      document.getElementById("popupMenu").style.display = "none";
    }

    function deleteDatabase() {
      if (confirm("Delete database '" + currentPopupDB + "'?")) {
        delete databases[currentPopupDB];
        saveDatabases();
        openDatabases();
      }
      document.getElementById("popupMenu").style.display = "none";
    }
  </script>
</body>
</html>
