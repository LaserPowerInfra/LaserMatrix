<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Laser Matrix</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --sidebar-w:220px;
      --accent:#1abc9c;
      --dark:#2c3e50;
      --muted:#34495e;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{display:flex;overflow:hidden;background:#f2f4f6;color:#222;}
    .sidebar{
      width:var(--sidebar-w);
      min-width:var(--sidebar-w);
      background: #add8e6;
      color:#fff;
      padding:18px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex-shrink:0;
    }
    .sidebar h2{margin:0 0 8px 0;text-align:center;color: #34495e; font-size:18px}
    .sidebar button{
      display:flex;align-items:center;gap:10px;
      background: #ff6666;
      color:#fff;border:0;padding:10px;border-radius:8px;cursor:pointer;
      font-size:15px;text-align:left;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), inset 0 -3px 0 rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }
    .sidebar button:hover{
      background: #e65c5c;
      color:#fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 -2px 0 rgba(0, 0, 0, 0.2);
      transform: translateY(1px);
    }
    .sidebar .spacer{flex-grow:1}
    #user-info {
        font-size: 12px;
        text-align: center;
        padding: 8px;
        background: rgba(0,0,0,0.1);
        border-radius: 6px;
        word-break: break-all;
    }
    .main {
      flex:1;
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      background:#fff;
    }
    .hero {
      position:relative;
      flex:1 0 auto;
      min-height:360px;
      perspective:1200px;
      overflow:hidden;
      background:#000;
    }
    .hero video{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
      -webkit-filter:brightness(0.7) saturate(1.05);filter:brightness(0.7) saturate(1.05);
    }
    .hero .overlay-top{
      position:absolute;
      top:28px;
      left:50%;
      transform:translateX(-50%);
      width:calc(100% - var(--sidebar-w) - 60px);
      max-width:1200px;
      pointer-events:none;
      text-align:center;
      z-index:5;
    }
    .three-d {
      display:inline-block;
      line-height:1;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      font-family: "Poppins", "Montserrat", Arial, sans-serif;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(220,255,240,0.9) 40%, rgba(26,188,156,0.95));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      font-size:56px;
      -webkit-text-stroke: 1px rgba(10,10,10,0.12);
      transform-origin:center top;
      transform: translateZ(40px) rotateX(6deg);
      display:block;
      margin:0 auto;
    }
    .sub-title{
      display:block;
      font-weight:700;
      letter-spacing:2px;
      color:rgba(255,255,255,0.95);
      text-shadow:0 2px 6px rgba(0,0,0,0.5);
      font-size:20px;
      margin-bottom:8px;
    }
    @media (max-width:1000px){
      .three-d{font-size:40px}
      .hero .overlay-top{top:20px}
    }
    @media (max-width:700px){
      .three-d{font-size:28px}
      .sub-title{font-size:14px}
      .hero{min-height:320px}
    }
    .panel {
      background:#f7f8fa;
      padding:18px;
      overflow:auto;
      height:calc(100vh - 40px);
    }
    .db-header { background:#fff;padding:10px;border-bottom:1px solid #e3e7ea;display:flex;align-items:center;justify-content:space-between;gap:12px; }
    .db-header input{padding:8px;border-radius:6px;border:1px solid #d6dbe0;width:220px}
    .db-item{display:flex;align-items:center;background:#fff;padding:8px;border-radius:6px;margin:8px 0;border:1px solid #e6ebee}
    .db-list{max-height:320px;overflow:auto;padding:10px}
    .table-wrap{background:#fff;padding:12px;border-radius:8px;border:1px solid #e6ebee}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e6ebee;padding:8px;text-align:left;font-size:13px; vertical-align: top;}
    thead {
        position: sticky;
        top: -1px;
        z-index: 10;
        transform: translateZ(0);
    }
    th{
        background:#f4f6f8;
    }
    .pagination{
        margin-top:12px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 13px;
        gap: 15px;
    }
    .btn{
      position: relative;
      overflow: hidden;
      background: #ff6666;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), inset 0 -3px 0 rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }
    .btn:hover{
      background: #e65c5c;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 -2px 0 rgba(0, 0, 0, 0.2);
      transform: translateY(1px);
    }
    .btn:disabled, .btn.loading {
      background: #cccccc;
      color: #888888;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .btn.loading::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(110deg, rgba(255,255,255,0) 8%, rgba(255,255,255,0.2) 18%, rgba(255,255,255,0) 33%);
        animation: shimmer 1.5s linear infinite;
        background-size: 200% 100%;
    }
    @keyframes shimmer {
        0% { background-position: 100% 0; }
        100% { background-position: -100% 0; }
    }
  </style>
</head>
<body>

  <div id="login-container" style="display: flex; justify-content: center; align-items: center; height: 100vh; width: 100%; flex-direction: column; background-color: var(--dark);">
    <h1 style="color: white; font-weight: 300;">Welcome to Laser Matrix</h1>
    <p style="color: #bdc3c7;">Please sign in to continue</p>
    <button id="login-btn" class="btn" style="background-color: var(--accent); font-size: 16px;">
      Sign in with Google
    </button>
  </div>

  <div id="app-container" style="display: none; width:100%; height:100%; flex-shrink: 0; flex-grow: 1;">
    <aside class="sidebar" role="navigation" aria-label="Main menu">
      <h2>üìÇ Menu</h2>
      <button onclick="goHome()">üè† Home</button>
      <button onclick="openDatabases()">üìä Databases</button>
      <button onclick="openForms()">üìù Forms</button>
      <div class="spacer"></div>
      <div id="user-info">Not signed in</div>
      <button id="logout-btn">üö™ Sign Out</button>
    </aside>

    <main class="main" id="main">
      <section class="hero" id="hero"></section>
      <section id="panelArea" class="panel" aria-live="polite" style="display:none;"></section>
    </main>

    <div id="popupMenu" class="filter-popup" style="min-width:140px; width:auto;"></div>
  </div>

<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

     {

¬† ¬† apiKey: "AIzaSyCmKA2ckvZ43rc30--fjgfn7klrMufghR0",

¬† ¬† authDomain: "laser-matrix.firebaseapp.com",

¬† ¬† projectId: "laser-matrix",

¬† ¬† storageBucket: "laser-matrix.firebasestorage.app",

¬† ¬† messagingSenderId: "246061144480",

¬† ¬† appId: "1:246061144480:web:7905774954b025114e6cc5",

¬† ¬† measurementId: "G-WKY8C6KRZK"

¬† }
    const firebaseConfig = {
      // apiKey: "...",
      // authDomain: "...",
      // projectId: "...",
      // etc.
    };

    // --- DO NOT EDIT BELOW THIS LINE ---

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userInfoDiv = document.getElementById('user-info');
    const hero = document.getElementById('hero');
    const panelArea = document.getElementById('panelArea');

    let localDatabases = {}; // In-memory cache
    let currentDbName = null;
    let currentPopupDB = null;

    loginBtn.addEventListener('click', () => {
        signInWithPopup(auth, provider).catch(error => {
            console.error("Authentication Error: ", error);
            alert("Could not sign in. Please try again.");
        });
    });

    logoutBtn.addEventListener('click', () => {
        signOut(auth).catch(error => {
            console.error("Sign Out Error: ", error);
        });
    });

    onAuthStateChanged(auth, user => {
        if (user) {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            userInfoDiv.textContent = user.email;
            goHome(); 
        } else {
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
            userInfoDiv.textContent = 'Not signed in';
        }
    });
    
    function renderHeroOverlay(){
        return `<div class="overlay-top" aria-hidden="true"><div class="sub-title">WELCOME TO</div><div class="three-d" data-text="LASER MATRIX">LASER MATRIX</div></div>`;
    }

    function goHome(){
        panelArea.style.display = 'none';
        hero.style.display = '';
        hero.innerHTML = `<video autoplay muted loop playsinline><source src="https://laserpowerinfra.com/frontassets/img/slider/Banner_v04_HD_L.mp4" type="video/mp4">Your browser does not support the video tag.</video>${renderHeroOverlay()}`;
    }

    function openForms(){
        hero.innerHTML = '';
        hero.style.display = 'none';
        panelArea.style.display = 'block';
        panelArea.innerHTML = `<div style="font-weight:700;margin-bottom:10px">Forms</div><div style="background:#fff;padding:12px;border-radius:8px">Forms functionality will go here.</div>`;
    }

    async function renderDbList(searchTerm = ''){
        const querySnapshot = await getDocs(collection(db, "databases"));
        let dbNames = [];
        querySnapshot.forEach((doc) => {
            dbNames.push(doc.id);
        });

        const filteredNames = dbNames.filter(n => n.toLowerCase().includes((searchTerm||'').toLowerCase()));
        const total = filteredNames.length;
        const listHtml = total > 0 ? filteredNames.map(name => `<div class="db-item"><div style="margin-right:10px;cursor:pointer" onclick="showMenu(event, '${escapeJs(name)}')">‚ãÆ</div><div style="flex:1;cursor:pointer" onclick="openDatabase('${escapeJs(name)}')">üìä ${escapeHtml(name)}</div></div>`).join('') : `<div style="padding:12px;background:#fff;border-radius:6px">No databases found.</div>`;
        
        const listContainer = document.getElementById('db-list-container');
        if (listContainer) listContainer.innerHTML = `<div class="db-list">${listHtml}</div>`;
        
        const totalElem = document.getElementById('db-total-count');
        if(totalElem) totalElem.textContent = `Total Count: ${total}`;
    }

    async function openDatabases(){
        hero.innerHTML = '';
        hero.style.display = 'none';
        panelArea.style.display = 'block';
        let structureHtml = `<div class="db-header"><div style="display:flex;align-items:center;gap:12px"><div style="display:flex; align-items:center; gap: 8px;"><input id="dbSearchInput" placeholder="Search Database" value=""><button class="btn" onclick="clearSearch()">Clear</button></div><div id="db-total-count" style="font-size:13px; color:#666; text-transform: uppercase; font-weight: bold;"></div></div><div><button class="btn" onclick="showImportForm()">‚ûï Add Database</button></div></div><div id="db-list-container">Loading databases...</div>`;
        panelArea.innerHTML = structureHtml;
        document.getElementById('dbSearchInput').addEventListener('input', (e) => { renderDbList(e.target.value); });
        await renderDbList('');
    }

    function clearSearch() {
        const input = document.getElementById('dbSearchInput');
        if (input) { input.value = ''; }
        renderDbList('');
    }

    function showImportForm(){
        hero.innerHTML = '';
        hero.style.display = 'none';
        panelArea.style.display = 'block';
        panelArea.innerHTML = `<div style="font-weight:700;margin-bottom:12px">Add Database</div><div style="background:#fff;padding:12px;border-radius:8px"><div style="margin-bottom:12px"><label><strong>From CSV File</strong></label><br><input type="file" id="csvFile" accept=".csv"><button class="btn" style="margin-left:8px" onclick="importCSV()">Upload</button></div><div id="statusBox" style="margin-top:8px"></div></div>`;
    }

    function importCSV(){
        const fi = document.getElementById('csvFile'), status = document.getElementById('statusBox');
        status.textContent = '';
        if(!fi || !fi.files || !fi.files.length){ status.textContent = '‚ö†Ô∏è Select a CSV file'; return; }
        const file = fi.files[0], dbName = file.name.replace(/\.csv$/i,'') || ('csvdb_' + Date.now());
        status.textContent = '‚è≥ Parsing...';
        
        Papa.parse(file, {
            header:true, skipEmptyLines:true, async complete(res){
                const headers = (res.meta.fields || []).map(h => ({name:h}));
                const rows = (res.data || []).map(r => (res.meta.fields || []).map(f => r[f] || ''));
                
                const dbData = {
                    headers: headers,
                    rows: rows,
                    createdAt: new Date().toISOString()
                };

                try {
                    status.textContent = '‚è≥ Uploading to Firebase...';
                    await setDoc(doc(db, "databases", dbName), dbData);
                    status.textContent = `‚úÖ Imported "${dbName}" successfully!`;
                    await openDatabases();
                } catch(e) {
                    console.error("Error writing document: ", e);
                    status.textContent = '‚ùå Failed to save to Firebase.';
                }
            },
            error(err){ status.textContent = '‚ùå Failed to parse file.'; }
        });
    }
    
    async function openDatabase(dbName){
        panelArea.innerHTML = `<h2>Loading data, please wait...</h2>`;
        currentDbName = dbName;
        
        const docRef = doc(db, "databases", dbName);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            localDatabases[dbName] = docSnap.data();
        } else {
            alert("Error: Database not found in Firestore.");
            openDatabases();
            return;
        }

        const currentDB = localDatabases[dbName];
        
        const headerHtml = (currentDB.headers||[]).map((h, i) => `<th><div class="th-content"><span>${escapeHtml(h.name)}</span></div></th>`).join('');
        const tableHtml = `
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <div style="font-weight:700;">${escapeHtml(dbName)}</div>
            <div style="display:flex; gap: 10px;">
                 <button class="btn" onclick="openDatabases()">‚¨ÖÔ∏è Back to List</button>
            </div>
          </div>
          <div class="table-wrap">
            <div style="overflow:auto; max-height:75vh;">
              <table id="data-table">
                <thead><tr>${headerHtml}</tr></thead>
                <tbody id="data-table-body"></tbody>
              </table>
            </div>
            <div id="pagination-container"></div>
          </div>
        `;
        panelArea.innerHTML = tableHtml;
        renderFilteredAndPagedTable(1);
    }
    
    function getFilteredRows() {
        const dbData = localDatabases[currentDbName];
        if (!dbData || !dbData.rows) return [];
        return dbData.rows;
    }

    function renderFilteredAndPagedTable(page = 1) {
        const filteredRows = getFilteredRows();
        const rowsPerPage = 100;
        const totalPages = Math.max(1, Math.ceil(filteredRows.length / rowsPerPage));
        page = Math.min(Math.max(1, page), totalPages);
        
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = filteredRows.slice(start, end);

        const body = document.getElementById('data-table-body');
        if(body) body.innerHTML = paginatedRows.map(r => `<tr>${r.map(c => `<td>${escapeHtml(String(c||''))}</td>`).join('')}</tr>`).join('');
        
        const paginationContainer = document.getElementById('pagination-container');
        if (paginationContainer) {
            const paginationHtml = `<div style="flex: 1; text-align: left;">Go to page: <input type="number" min="1" max="${totalPages}" value="${page}" onchange="jumpToPage(this.value)" style="width: 60px;"></div><div style="flex: 1; text-align: center;"><button class="btn" onclick="renderFilteredAndPagedTable(${page - 1})" ${page === 1 ? 'disabled' : ''}>‚¨Ö Prev</button><span style="margin:0 8px">Page ${page} of ${totalPages}</span><button class="btn" onclick="renderFilteredAndPagedTable(${page + 1})" ${page === totalPages ? 'disabled' : ''}>Next ‚û°</button></div><div style="flex: 1; text-align: right; font-weight: bold;" id="data-count-display">Data Count: ${filteredRows.length}</div>`;
            paginationContainer.innerHTML = `<div class="pagination">${paginationHtml}</div>`;
        }
    }
    
    function jumpToPage(value) {
        const pageNum = parseInt(value);
        if (pageNum && pageNum > 0) {
            renderFilteredAndPagedTable(pageNum);
        }
    }

    function showMenu(ev, dbName){
        ev.stopPropagation();
        currentPopupDB = dbName;
        const menu = document.getElementById('popupMenu');
        menu.innerHTML = `<div style="padding:8px;cursor:pointer" onclick="renameDatabase()">üìù Rename</div><div style="padding:8px;cursor:pointer" onclick="deleteDatabase()">üóë Delete</div>`;
        menu.style.display='block';
        menu.style.left = (ev.clientX - 10) + 'px';
        menu.style.top  = (ev.clientY + 6) + 'px';
    }
    document.addEventListener('click', ()=> {
        const menu = document.getElementById('popupMenu');
        if(menu) menu.style.display='none';
    });

    function renameDatabase(){
        alert("This feature needs to be updated for Firestore.");
    }
    async function deleteDatabase(){
        if(!confirm('Delete database "' + currentPopupDB + '" from Firebase?')) return;
        try {
            await deleteDoc(doc(db, "databases", currentPopupDB));
            alert('Database deleted successfully.');
            openDatabases();
        } catch (e) {
            console.error("Error deleting document: ", e);
            alert("Failed to delete database.");
        }
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function escapeJs(s){ return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

    window.goHome = goHome;
    window.openDatabases = openDatabases;
    window.openForms = openForms;
    window.clearSearch = clearSearch;
    window.showImportForm = showImportForm;
    window.importCSV = importCSV;
    window.openDatabase = openDatabase;
    window.showMenu = showMenu;
    window.renameDatabase = renameDatabase;
    window.deleteDatabase = deleteDatabase;
    window.jumpToPage = jumpToPage;
    window.renderFilteredAndPagedTable = renderFilteredAndPagedTable;
</script>

</body>
</html>